kind: secret
name: minio-key-id
get:
  path: mlflow-server-secret
  name: AWS_ACCESS_KEY_ID

---

kind: secret
name: minio-secret
get:
  path: mlflow-server-secret
  name: AWS_SECRET_ACCESS_KEY

---

kind: pipeline
type: kubernetes
name: test-components

# trigger:
#   ref:
#   - refs/tags/check-components-*

environment:
  PYTHONPATH: /drone/lab/lib
  MINIO_DATA_FOLDER: /shared-storage/kdl-project-template/data
     
steps:
  - name: check_minio_connection
    image: terminus7/sci-toolkit-runner:1.1.0
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: minio-key-id
      AWS_SECRET_ACCESS_KEY:
        from_secret: minio-secret
    commands:
      - python3 lab/processes/check_minio_connection/main.py
    volumes:
        - name: shared-storage
          path: /shared-storage

  - name: check_mlflow_connection
    image: terminus7/sci-toolkit-runner:1.1.0
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: minio-key-id
      AWS_SECRET_ACCESS_KEY:
        from_secret: minio-secret
    commands:
      - python3 lab/processes/check_mlflow_connection/main.py
    volumes:
        - name: shared-storage
          path: /shared-storage

  - name: check_import_from_lib
    image: terminus7/sci-toolkit-runner:1.1.0
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: minio-key-id
      AWS_SECRET_ACCESS_KEY:
        from_secret: minio-secret
    commands:
      - python3 lab/processes/check_import_from_lib/main.py
    volumes:
        - name: shared-storage
          path: /shared-storage

  - name: check_unit_tests
    image: terminus7/sci-toolkit-runner:1.1.0
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: minio-key-id
      AWS_SECRET_ACCESS_KEY:
        from_secret: minio-secret
    commands:
      - pytest lab/processes/check_unit_tests/main.py
    volumes:
        - name: shared-storage
          path: /shared-storage

volumes:
  - name: shared-storage
    claim:
      name: received-data-claim

---