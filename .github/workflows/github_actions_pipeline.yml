name: experiments
on:
  push:

env:
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  PYTHONPATH: ${{ github.workspace }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  MLFLOW_S3_ENDPOINT_URL: https://minio.kdl-dell.konstellation.io
  TODO: Change bucket name
  MLFLOW_URL: https://<bucket-name>-mlflow.kdl-dell.konstellation.io
  GIT_SHA: ${{ github.sha }}

jobs:
  train-and-report:
    if: "contains(github.event.head_commit.message, 'experiment:')"
    runs-on: ["igz", "dell", "cpu"]
    container:
      image: konstellation/kdl-py:3.9-1.5.0
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Pipenv setup
        run: |
          pipenv sync --system

      - name: Remote setup
        run: |
          TODO:
          git remote add experiments_adress https://oauth2:${{ env.REPO_TOKEN }}<http address of remote repository>

      - name: Set experiment name
        id: vars
        run: echo "SHA_SHORT=$(git rev-parse --short=7 HEAD)" >> $GITHUB_ENV

      - name: Pull raw data
        run: |
          dvc pull lab/data/raw --recursive

      - name: Run Experiment ${{ env.SHA_SHORT }}
        run: |
          dvc exp run --name "${{ env.SHA_SHORT }}" --pull

      - name: Share experiment
        run: |
          dvc exp push experiments_adress "${{ env.SHA_SHORT }}"
